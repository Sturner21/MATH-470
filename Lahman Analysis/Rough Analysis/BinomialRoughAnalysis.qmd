---
title: "Binomial Rough Analysis"
format: html
---

# Load Libraries

```{r}
library(tidyverse)
library(rethinking)
library(Lahman)
library(scales)
```

# Clean Lahman

```{r}
Batting <- Lahman::Batting

Batting <- Batting %>% 
  filter(yearID >= 1945) %>% 
  select(playerID, yearID, lgID, AB, AB, HR) %>% 
  mutate(lg = ifelse(lgID=="NL",1,2))

Batting2 <- Batting %>% 
  filter(yearID >=1973 & yearID <=2021)
```

# From Meeting

```{r}
rate <- Batting %>% 
  group_by(yearID) %>% 
  summarize(sHR = sum(HR),
            sAB = sum(AB)) %>% 
  mutate(p = sHR / sAB,
         se = sqrt(p*(1-p)/sAB))
```

```{r}
ggplot(data=rate)+
  aes(x=yearID, y=p)+
  geom_point()+
  scale_y_continuous(labels=label_percent(), limits = c(0,NA))
```

```{r}
#rate2 <- 
Batting2 %>% 
  group_by(lgID) %>% 
  summarize(sHR = sum(HR),
            sAB = sum(AB)) %>% 
  mutate(p = sHR / sAB,
         se = sqrt(p*(1-p)/sAB))
```

```{r}
rate2 <- Batting2 %>% 
  group_by(yearID, lgID) %>% 
  summarize(sHR = sum(HR),
            sAB = sum(AB)) %>% 
  mutate(p = sHR / sAB,
         se = sqrt(p*(1-p)/sAB)) %>% 
  select(yearID, lgID, p) %>% 
  ungroup() %>% 
  pivot_wider(names_from = lgID, values_from = p) %>% 
  mutate(diff = AL - NL)
```

```{r}
ggplot(data=rate2)+
  aes(x=yearID, y=diff)+
  geom_point()
```

```{r}
ggplot(data=rate2)+
  aes(x=diff)+
  geom_histogram()
```

```{r}
Batting3 <-  Batting %>% 
  group_by(yearID, lgID) %>% 
  summarize(sAB = sum(AB), sHR = sum(HR)) %>% 
  mutate(year = yearID-1944,
         lg = case_when(lgID=="NL" ~ 1,
                        lgID=="AL" ~ 2))
```

```{r}
slim2 <- list(
  N = nrow(Batting3),
  z = n_distinct(Batting3$yearID),
  YEAR = Batting3 %>% pull(year),
  AB = Batting3 %>% pull(sAB),
  HR = Batting3 %>% pull(sHR),
  LG = Batting3 %>% pull(lg)
)

str(slim2)
```

# Stan

See Stan file

```{r}
fit <- stan(
  file = "RoughBinomAnalysis.stan",
  data = slim2,
  chains = 4,
  warmup = 1000,
  iter= 5000,
  cores = 4,
  refresh=100
)
```

```{r}
plot(fit)
```

```{r}
print(fit)
```

```{r}
traceplot(fit)
```

```{r}
saveRDS(fit, file="fit.rds")
readRDS("fit.rds")
```

# Ulam

```{r}
head(Batting)
```

```{r}
slim <- list(
  AB = Batting$AB,
  HR = Batting$HR,
  LG = Batting$lg,
  #Need to subtract by 1944 to make it an index variable instead of a number
  YEAR = Batting$yearID -1944
)

str(slim)
```

```{r}
#Recommended model format from Dr.Parson on 10/6/23
u1 <- ulam(
  alist(
    HR ~ dbinom(AB,p),
    logit(p) <- a[LG],
    a[LG] ~ dnorm(0,10)
  ), data=slim, chains=4, cores=4
)
```

```{r}
precis(u1, depth=2)
```

```{r}
#Since the mode says -3, lets refine the model a little bit
u2 <- ulam(
  alist(
    HR ~ dbinom(AB,p),
    logit(p) <- a[LG],
    a[LG] ~ dnorm(0,2)
  ), data=slim, chains=2, cores=2
)
```

```{r}
precis(u2, depth=2)
```

These "a" represent the logit probability change in hitting a homerun from each AB. To find this in probability terms, it would be `inv_logit(a[i])`, which becomes about 2%. And when running an LM we get a coefficient of about 0.03. Thus, this result is believable but on the higher end of what I would have expected.

```{r}
#Let's include year as a parameter on p since I've already assumed it mattered!
u3 <- ulam(
  alist(
    HR ~ dbinom(AB,p),
    logit(p) <- a[LG] + b[YEAR],
    a[LG] ~ dnorm(0,2),
    b[YEAR] ~ dnorm(0,10)
  ), data=slim, chains=2, cores=2
)
```

```{r}
precis(u3, depth=2)
```

Is there a way I can extract this and view the walk of `b[i]` as it changes to see how home runs have changed over the years?

```{r}
trankplot(u3)
```

# Replicate

The use the following model:

$$
HR_{i,j}\sim Binom(AB_{i,j}, p_{i,j})\\
logit(p_{i,j})=\beta_1 Age+\beta_2 Ballpark+\beta_3 Year
$$

```{r}
r1 <- ulam(
  alist(
    HR ~ dbinom(AB,p),
    logit(p) <- a[LG],
    a[LG] ~ dnorm(0,2)
  ), data=slim, chains=2, cores=2
)
```

One question I have here, why only choose one ballpark per player? Why not consider all ballparks the player played at in a season.

I would want to run the following model

$$
HR_{i,j}\sim Binom(AB_{i,j}, p_{i,j})\\
logit(p_{i,j})=\beta_1 Age+\beta_2 Ballpark + \beta_3Year+\beta_4SB
$$

Since stolen bases suggest a different archetype of player. One who's inherent underlying probability of hitting a homerun is lower.
